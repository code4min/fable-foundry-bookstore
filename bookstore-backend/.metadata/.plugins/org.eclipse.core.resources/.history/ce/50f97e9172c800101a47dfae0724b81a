package com.bookstore.controller;

import com.bookstore.dto.ChatRequest;
import com.bookstore.model.Book;
import com.bookstore.service.BookService;
import com.bookstore.service.GeminiService;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/ai")
@CrossOrigin(origins = "http://localhost:3000")
public class AiChatController {

    @Autowired
    private GeminiService geminiService;

    @Autowired
    private BookService bookService;

    @PostMapping(value = "/chat", consumes = "application/json", produces = "text/plain")
    public String chat(@RequestBody ChatRequest request) {

        String userMessage = request.getMessage();
        if (userMessage == null || userMessage.trim().isEmpty()) {
            return "Please write a message.";
        }

        // üîç STEP 1: Try searching books in database
        List<Book> results =
                bookService.searchByTitleOrAuthor(userMessage.toLowerCase());

        if (!results.isEmpty()) {
            // üìö STEP 2: Build a human-friendly response
            StringBuilder reply = new StringBuilder();
            reply.append("Here‚Äôs what I found in your bookstore:\n\n");

            for (Book book : results) {
                reply.append("üìò *")
                        .append(book.getTitle())
                        .append("* by ")
                        .append(book.getAuthor())
                        .append("\nStock: ")
                        .append(book.getStock() > 0 ? (book.getStock() + " available") : "Out of stock")
                        .append("\nPrice: ‚Çπ")
                        .append(book.getPrice())
                        .append("\n\n");
            }

            return reply.toString();
        }

        // ü§ñ STEP 3: If NOT related to books ‚Üí send to Gemini AI
        return geminiService.generateResponse(userMessage);
    }
}
