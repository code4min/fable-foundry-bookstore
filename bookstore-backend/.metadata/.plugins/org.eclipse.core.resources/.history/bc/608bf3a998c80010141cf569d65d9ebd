package com.bookstore.controller;

import com.bookstore.service.GeminiService;
import com.bookstore.service.BookService;
import com.bookstore.dto.ChatRequest;
import com.bookstore.model.Book;

import org.springframework.web.bind.annotation.*;
import org.springframework.beans.factory.annotation.Autowired;

import java.util.List;

@RestController
@RequestMapping("/api/ai")
@CrossOrigin(origins = "http://localhost:3000")
public class AiChatController {

    private final GeminiService geminiService;
    private final BookService bookService;

    @Autowired
    public AiChatController(GeminiService geminiService, BookService bookService) {
        this.geminiService = geminiService;
        this.bookService = bookService;
    }

    @PostMapping(value = "/chat", consumes = "application/json", produces = "text/plain")
    public String chat(@RequestBody ChatRequest request) {

        String userMessage = request.getMessage();

        if (userMessage == null || userMessage.trim().isEmpty()) {
            return "Please write a message.";
        }

        // üîç Detect if user is asking about a book title
        List<Book> matchedBooks = bookService.searchBooks(userMessage);

        String dbContext;

        if (matchedBooks.isEmpty()) {
            dbContext = "No matching books found in the inventory.";
        } else {
            StringBuilder contextBuilder = new StringBuilder();
            contextBuilder.append("Matching books in Fable Foundry inventory:\n");

            for (Book book : matchedBooks) {
                contextBuilder.append("- ")
                        .append(book.getTitle())
                        .append(" by ").append(book.getAuthor())
                        .append(" | Price: ").append(book.getPrice())
                        .append(" | Stock: ").append(book.getStock())
                        .append("\n");
            }

            dbContext = contextBuilder.toString();
        }

        // üß† Send both userMessage + dbContext to AI
        return geminiService.generateResponse(userMessage, dbContext);
    }
}
